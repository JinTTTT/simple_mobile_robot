# Mapping Package

Builds 2D occupancy grid maps from lidar scans and odometry.

## Usage

```bash
# Build
cd ~/workspace/gazebo_ws
colcon build --packages-select mapping
source install/setup.bash
```
```bash
#Run
ros2 run mapping occupancy_mapper

# Visualize in RViz
# Set Fixed Frame to "odom"
# Add → Map → Topic: /map
```

## Generate pgm map for localization 
(the map generated by occupancy_mapper is not good enough for localization)
1. Generate a map from a SDF file
```bash
cd /scripts
python3 generate_pgm_map.py
```
It will generate a map in the maps folder. Then you have to add .yaml file as interface to let map_server use the map.

2. Use map_serverto publish it as a topic `/map`
```bash
ros2 run nav2_map_server map_server --ros-args -p yaml_filename:=src/mapping/maps/maze_map.yaml
```
Map server is lifecycle node, you need to activate with a new terminal:
```bash
ros2 run nav2_util lifecycle_bringup map_server
```
You should see `/map` topic published.

3. If you don't have running tf with map frame(map use it as its frame), you won't see it in rviz2. Try this as temporary fix:
```bash
ros2 run tf2_ros static_transform_publisher 0 0 0 0 0 0 map odom
```


## Algorithm used

**Bresenham ray tracing:**
- To return the cells that the laser beam hits.

**Log-Odds Bayesian Update Method:**
- To update the occupancy grid map based on the laser scan.
- Gradually update using bayesian.


## Current Issues to solve

1. Cannot detect removed obstacles. Once an obstacle is mapped, removing it physically won't update the map. 

2. Trusts odometry 100%, no correction. 

3. No loop closure - Cannot detect when returning to known locations, no map optimization.

---

